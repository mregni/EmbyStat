trigger:
- develop

pr:
  branches:
    include:
    - develop
    - release/*
    exclude:
    - dependabot/*
    
variables:
  - group: dev-build
  - group: packages
  - name: WinPool
    value: 'windows-2022'
  - name: LinuxPool
    value: 'ubuntu-20.04'

pool:
  vmImage: $(WinPool)

stages:
  - stage: test_stage
    displayName: Test
    jobs:
    - job: main_build
      displayName: 'Test application'
      steps:
      - template: './templates/version.variables.yml'
      - template: './templates/update.version.yml'
      - template: './templates/sonarcloud.start.yml'

      - task: PowerShell@2
        displayName: 'Update appsettings.json file'
        inputs:
          targetType: filePath
          filePath: $(paths.script)/appsettings.ps1
          arguments: '-updatePackage $(package.win10-x64) -rollbarKey $(rollbar.key) -version $(GitVersion.SemVer)'
    
      - task: DotNetCoreCLI@2
        displayName: 'Restore NuGet packages'
        inputs:
          command: 'restore'
          projects: '$(webapp.project)'

      - task: DotNetCoreCLI@2
        displayName: 'Build web app'
        inputs:
          projects: '$(webapp.project)'
          arguments: '--output publish'
    
      - template: './templates/unit.tests.yml'
      - template: './templates/sonarcloud.end.yml'

  - stage: build_artifacts
    dependsOn: test_stage
    condition: succeeded()
    displayName: 'Build artifacts'
    jobs:
    - template: './win-x64/build.pipeline.yml'

    - ${{ if eq(variables['Build.SourceBranchName'], 'develop') }}:
      - template: './docker-containers/win.pipeline.yml'
      - template: './docker-containers/linux.pipeline.yml'
      - template: './docker-containers/arm64.pipeline.yml'
      - template: './docker-containers/build.pipeline.yml'

  - stage: publish
    dependsOn: build_artifacts
    condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'develop'))
    displayName: 'Publish artifacts'
    jobs:
      - job: win_docker_publish
        displayName: 'Publish Windows docker images'
        variables:
          GitVersion.AssemblySemVer: $[stageDependencies.test_stage.main_build.outputs['setAssemblySemVer.AssemblySemVer'] ]
          GitVersion.SemVer: $[stageDependencies.test_stage.main_build.outputs['setSemVer.SemVer'] ]     
        steps:
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Windows Artifact'
            inputs:
              buildType: specific
              project: '60c279c7-80b3-445f-8d2e-45e07778a9e6'
              definition: 10
              artifactName: 'EmbyStat-$(package.win10-x64)-v$(GitVersion.SemVer)'
          - task: Docker@2
            displayName: Login
            inputs:
              containerRegistry: 'Docker hub'
              command: login
          - task: Docker@2
            displayName: 'Build and Push container'
            inputs:
              containerRegistry: 'Docker hub'
              repository: uping/embystat
              Dockerfile: '$(System.DefaultWorkingDirectory)/builds/docker-containers/win.dockerfile'
              buildContext: '$(System.DefaultWorkingDirectory)/EmbyStat-$(package.win10-x64)-v$(GitVersion.SemVer)'
              tags: 'nightly-win-x64'
          - task: Docker@2
            displayName: Logout
            inputs:
              containerRegistry: 'Docker hub'
              command: logout
      - job: ubuntu_docker_publish
        displayName: 'Publish Ubuntu docker images'
        variables:
          GitVersion.AssemblySemVer: $[stageDependencies.test_stage.main_build.outputs['setAssemblySemVer.AssemblySemVer'] ]
          GitVersion.SemVer: $[stageDependencies.test_stage.main_build.outputs['setSemVer.SemVer'] ]
        steps:
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Ubuntu Artifact'
            inputs:
              buildType: specific
              project: '60c279c7-80b3-445f-8d2e-45e07778a9e6'
              definition: 10
              artifactName: 'EmbyStat-docker-linux-v$(GitVersion.SemVer)'
          - task: Docker@2
            displayName: Login
            inputs:
              containerRegistry: 'Docker hub'
              command: login
          - task: Docker@2
            displayName: 'Build and Push container'
            inputs:
              containerRegistry: 'Docker hub'
              repository: uping/embystat
              Dockerfile: '$(System.DefaultWorkingDirectory)/builds/docker-containers/win.dockerfile'
              buildContext: '$(System.DefaultWorkingDirectory)/EmbyStat-docker-linux-v$(GitVersion.SemVer)'
              tags: 'nightly-win-x64'
          - task: Docker@2
            displayName: Logout
            inputs:
              containerRegistry: 'Docker hub'
              command: logout
      - job: docker_manifest_publish
        displayName: 'Publish manifest data'
        dependsOn: 
          - ubuntu_docker_publish
          - win_docker_publish
        condition: succeeded()
        steps:
          - task: Docker@2
            displayName: Login
            inputs:
              containerRegistry: 'Docker hub'
              command: login
          - script: 'manifest-tool-windows-amd64.exe push from-spec manifest-nightly.yaml'
            workingDirectory: '$(System.DefaultWorkingDirectory)/builds/docker-containers/files'
            displayName: 'Pushing manifest file to Docker Hub'
          - task: Docker@2
            displayName: Logout
            inputs:
              containerRegistry: 'Docker hub'
              command: logout
      - job: rollbar_publish
        displayName: 'Publish info to Rollbar'
        dependsOn: docker_manifest_publish
        condition: succeeded()
        variables:
          GitVersion.AssemblySemVer: $[stageDependencies.test_stage.main_build.outputs['setAssemblySemVer.AssemblySemVer'] ]
          GitVersion.SemVer: $[stageDependencies.test_stage.main_build.outputs['setSemVer.SemVer'] ]
        steps:
          - powershell: |
              $environment = "dev"
              $postParams = @{
                  access_token="$(rollbar.key)";
                  environment="$environment";
                  revision="$(GitVersion.SemVer)";
                  local_username="MikhaÃ«l Regni";
                  status="succeeded";
                }
                Invoke-WebRequest -Uri https://api.rollbar.com/api/1/deploy -Method POST -UseBasicParsing -Body $postParams
            displayName: 'Publishing deploy on Rollbar'